<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>IFRAS ‚Äî Messagerie interne</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  font-family: Segoe UI, Roboto, Arial, sans-serif;
  background-color: #050b1e;
  color: #e6e6e6;
}

header {
  background: linear-gradient(180deg, #0a1a3a, #050b1e);
  padding: 20px;
  border-bottom: 1px solid #1b2555;
}

main {
  display: flex;
  height: calc(100vh - 90px);
}

.sidebar {
  width: 260px;
  background: #070f2b;
  border-right: 1px solid #1b2555;
  padding: 20px;
}

.folder {
  margin: 12px 0;
  font-size: 14px;
  color: #aab3d6;
  cursor: pointer;
}

.folder.active,
.folder:hover {
  color: white;
  font-weight: 600;
}

.inbox {
  width: 360px;
  border-right: 1px solid #1b2555;
  overflow-y: auto;
}

.message {
  padding: 15px;
  border-bottom: 1px solid #1b2555;
  cursor: pointer;
}

.message:hover {
  background: rgba(79,107,237,0.08);
}

.reader {
  flex: 1;
  padding: 30px;
  overflow-y: auto;
}

.meta {
  font-size: 13px;
  color: #9ca3af;
  margin-bottom: 15px;
}

.content {
  white-space: pre-wrap;
  line-height: 1.7;
}

.attach {
  margin-top: 20px;
}
</style>
</head>

<body>

<header>
  <h1>Messagerie s√©curis√©e IFRAS</h1>
</header>

<main>

<div class="sidebar">
  <div class="folder active" onclick="loadFolder('inbox', this)">üì• Bo√Æte de r√©ception</div>
  <div class="folder" onclick="loadFolder('sent', this)">üì§ Envoy√©s</div>
  <div class="folder" onclick="loadFolder('favorites', this)">‚≠ê Favoris</div>
  <div class="folder" onclick="loadFolder('classified', this)">üîí Classifi√©s</div>
  <div class="folder" onclick="loadFolder('trash', this)">üóë Corbeille</div>
</div>

<div class="inbox" id="inbox"></div>

<div class="reader" id="reader">
  <p>S√©lectionnez un message.</p>
</div>

</main>

<script>
const supabaseClient = supabase.createClient(
  "https://fqijbltymdeudnlitcrs.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxaWpibHR5bWRldWRubGl0Y3JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzOTQ2NDQsImV4cCI6MjA4NTk3MDY0NH0.HZA0VxkaRTGLRTBA0Vz51mJjw8Xuj8f__yzaQKpGfbE"
);

let currentFolder = "inbox";
let userEmail = "";

async function loadFolder(folder, el) {
  document.querySelectorAll(".folder").forEach(f => f.classList.remove("active"));
  el.classList.add("active");
  currentFolder = folder;
  loadMessages();
}

async function loadMessages() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) return window.location.href = "connexion.html";

  userEmail = user.email;

  let query = supabaseClient
    .from("email")
    .select("*")
    .eq("folder", currentFolder)
    .order("sent_at", { ascending: false });

  if (currentFolder === "sent") {
    query = query.eq("sender", userEmail);
  } else {
    query = query.eq("receiver", userEmail);
  }

  const { data, error } = await query;
  if (error) return console.error(error);

  const inbox = document.getElementById("inbox");
  inbox.innerHTML = "";

  if (!data.length) {
    inbox.innerHTML = "<p style='padding:20px;color:#777'>Aucun message</p>";
    document.getElementById("reader").innerHTML = "<p>S√©lectionnez un message.</p>";
    return;
  }

  data.forEach(mail => {
    const div = document.createElement("div");
    div.className = "message";
    div.innerHTML = `<strong>${currentFolder === 'sent' ? mail.receiver : mail.sender}</strong><br>${mail.subject}`;
    div.onclick = () => openMessage(mail);
    inbox.appendChild(div);
  });

  openMessage(data[0]);
}

function openMessage(mail) {
  document.getElementById("reader").innerHTML = `
    <h2>${mail.subject}</h2>
    <div class="meta">
      De : ${mail.sender}<br>
      √Ä : ${mail.receiver}<br>
      ${new Date(mail.sent_at).toLocaleString()}
    </div>
    <div class="content">${mail.body}</div>
    ${mail.attachment ? `<div class="attach"><a href="${mail.attachment}" target="_blank">üìé Pi√®ce jointe</a></div>` : ""}
  `;
}

loadMessages();
</script>

</body>
</html>
