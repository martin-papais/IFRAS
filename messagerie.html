<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>IFRAS ‚Äî Messagerie interne</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg-main: #050b1e;
  --bg-dark: #020617;
  --bg-light: #070f2b;
  --accent: #4f6bed;
  --text-main: #e6e6e6;
  --text-soft: #aab3d6;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  background: var(--bg-main);
  color: var(--text-main);
}

/* ===== HEADER ===== */
header {
  position: fixed;
  top: 0;
  width: 100%;
  z-index: 1000;
  background: rgba(5,11,30,.75);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid #1b2555;
}

.header-inner {
  max-width: 1300px;
  margin: auto;
  padding: 12px 30px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 40px;
}

.logo-link img {
  height: 60px;
}

.main-nav {
  list-style: none;
  display: flex;
  gap: 32px;
  margin: 0;
  padding: 0;
}

.main-nav a {
  text-decoration: none;
  color: var(--text-soft);
  font-size: 14px;
}

.main-nav a:hover { color: white; }

.header-right .logout-btn {
  padding: 8px 18px;
  border-radius: 6px;
  border: 1px solid var(--accent);
  color: white;
  text-decoration: none;
  font-size: 13px;
  cursor: pointer;
}

.header-right .logout-btn:hover {
  background: var(--accent);
}

/* ===== SOUS BANDEAU ===== */
.sub-nav {
  margin-top: 84px;
  background: var(--bg-light);
  border-bottom: 1px solid #1b2555;
}

.sub-nav ul {
  max-width: 1300px;
  margin: auto;
  padding: 0 30px;
  list-style: none;
  display: flex;
  justify-content: center;
  gap: 60px;
}

.sub-nav li {
  padding: 14px 0;
}

.sub-nav a {
  color: var(--text-soft);
  text-decoration: none;
  font-size: 14px;
  letter-spacing: .05em;
}

.sub-nav a:hover,
.sub-nav .active {
  color: white;
  border-bottom: 2px solid var(--accent);
  padding-bottom: 6px;
}

/* ===== LAYOUT ===== */
main {
  margin-top: 140px;
  display: flex;
  height: calc(100vh - 140px);
}

/* ===== SIDEBAR ===== */
.sidebar {
  width: 260px;
  background: var(--bg-light);
  border-right: 1px solid #1b2555;
  padding: 20px;
}

.folder {
  margin: 12px 0;
  font-size: 14px;
  color: var(--text-soft);
  cursor: pointer;
}

.folder.active,
.folder:hover {
  color: white;
  font-weight: 600;
}

/* ===== LISTE MESSAGES ===== */
.inbox {
  width: 360px;
  border-right: 1px solid #1b2555;
  overflow-y: auto;
}

.message {
  padding: 15px;
  border-bottom: 1px solid #1b2555;
  cursor: pointer;
}

.message:hover {
  background: rgba(79,107,237,0.08);
}

/* ===== LECTURE ===== */
.reader {
  flex: 1;
  padding: 30px;
  overflow-y: auto;
}

.meta {
  font-size: 13px;
  color: #9ca3af;
  margin-bottom: 15px;
}

.content {
  white-space: pre-wrap;
  line-height: 1.7;
}

.attach {
  margin-top: 20px;
}
</style>
</head>

<body>

<header>
  <div class="header-inner">
    <div class="header-left">
      <a href="index.html" class="logo-link">
        <img src="logo.png" alt="Logo IFRAS">
      </a>
      <nav>
        <ul class="main-nav">
          <li><a href="index.html">Accueil</a></li>
          <li><a href="recherche.html">Recherche</a></li>
          <li><a href="programmes.html">Programmes</a></li>
          <li><a href="publications.html">Publications</a></li>
        </ul>
      </nav>
    </div>
    <div class="header-right">
      <a class="logout-btn" onclick="logout()">D√©connexion</a>
    </div>
  </div>
</header>

<nav class="sub-nav">
  <ul>
    <li><a href="messagerie.html" class="active">Messagerie</a></li>
    <li><a href="coffre-fort.html">Coffre-fort</a></li>
    <li><a href="profil.html">Profil</a></li>
  </ul>
</nav>

<main>

<div class="sidebar">
  <div class="folder active" onclick="loadFolder('inbox', this)">üì• Bo√Æte de r√©ception</div>
  <div class="folder" onclick="loadFolder('sent', this)">üì§ Envoy√©s</div>
  <div class="folder" onclick="loadFolder('favorites', this)">‚≠ê Favoris</div>
  <div class="folder" onclick="loadFolder('classified', this)">üîí Classifi√©s</div>
  <div class="folder" onclick="loadFolder('trash', this)">üóë Corbeille</div>
</div>

<div class="inbox" id="inbox"></div>

<div class="reader" id="reader">
  <p>S√©lectionnez un message.</p>
</div>

</main>

<script>
const supabaseClient = supabase.createClient(
  "https://fqijbltymdeudnlitcrs.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxaWpibHR5bWRldWRubGl0Y3JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzOTQ2NDQsImV4cCI6MjA4NTk3MDY0NH0.HZA0VxkaRTGLRTBA0Vz51mJjw8Xuj8f__yzaQKpGfbE"
);

let currentFolder = "inbox";
let userEmail = "";

async function logout() {
  await supabaseClient.auth.signOut();
  window.location.href = "connexion.html";
}

async function loadFolder(folder, el) {
  document.querySelectorAll(".folder").forEach(f => f.classList.remove("active"));
  el.classList.add("active");
  currentFolder = folder;
  loadMessages();
}

async function loadMessages() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) return window.location.href = "connexion.html";

  userEmail = user.email;

  let query = supabaseClient
    .from("email")
    .select("*")
    .order("send_at", { ascending: false });

  if (currentFolder === "sent") {
    query = query.eq("sender", userEmail).eq("sender_folder", "sent");
  } else if (currentFolder === "trash") {
    query = query.or(
      `receiver.eq.${userEmail}.and(folder.eq.trash),sender.eq.${userEmail}.and(sender_folder.eq.trash)`
    );
  } else {
    query = query.eq("receiver", userEmail).eq("folder", currentFolder);
  }

  const { data, error } = await query;
  if (error) return console.error(error);

  const inbox = document.getElementById("inbox");
  inbox.innerHTML = "";

  if (!data.length) {
    inbox.innerHTML = "<p style='padding:20px;color:#777'>Aucun message</p>";
    document.getElementById("reader").innerHTML = "<p>S√©lectionnez un message.</p>";
    return;
  }

  data.forEach(mail => {
    const contact = (mail.sender === userEmail) ? mail.receiver : mail.sender;
    const div = document.createElement("div");
    div.className = "message";
    div.innerHTML = `<strong>${contact}</strong><br>${mail.subject}`;
    div.onclick = () => openMessage(mail);
    inbox.appendChild(div);
  });

  openMessage(data[0]);
}

function openMessage(mail) {
  document.getElementById("reader").innerHTML = `
    <h2>${mail.subject}</h2>
    <div class="meta">
      De : ${mail.sender}<br>
      √Ä : ${mail.receiver}<br>
      ${new Date(mail.send_at).toLocaleString()}
    </div>
    <div class="content">${mail.body}</div>
    ${mail.attachment ? `<div class="attach"><a href="${mail.attachment}" target="_blank">üìé Pi√®ce jointe</a></div>` : ""}
  `;
}

loadMessages();
</script>

</body>
</html>
